---
title: "Chapter 11, Vignette 2: ROC-DBMH sample size from first principles"
author: "Dev P. Chakraborty"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: myRefs.bib
vignette: >
  %\VignetteIndexEntry{ROC sample size}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(RJafroc)
library(ggplot2)
```

## Introduction
The starting point is a **pilot** study. The variability information in this study, obtained by running the significance testing function `StSignificanceTesting()`, is used to infer the necessary numbers of readers and cases, in the **pivotal** study, to achieve the desired power. In this example the Van Dyke dataset is regarded as a pilot study. Shown next is a first principles implementation of the relevant formulae in **Chapter 11**.  


## Sample size estimation using the DBMH method
The Van Dyke dataset in file `VanDyke.lrc`, in `"MRMC"` format, is regarded as a pilot study. The command `rocData <- DfReadDataFile(fileName, format = "MRMC")` reads the data and saves it to a `dataset` object `rocData`. The next line uses the function `StSignificanceTesting()` to apply `"DBMH"` analysis using the `"Wilcoxon"` figure of merit. The next line extracts the needed variance components `varYTR`, `varYTC` and `varYEps` (the Y's denote pseudovalue based values). The next line extracts the effect size.

```{r}
alpha <- 0.05;cat("alpha = ", alpha, "\n")
fileName <- "VanDyke.lrc"
#fileName <- "Franken1.lrc"
rocData <- DfReadDataFile(fileName, format = "MRMC")
retDbm <- StSignificanceTesting(dataset = rocData, FOM = "Wilcoxon", method = "DBMH") 
varYTR <- retDbm$varComp$varComp[3];varYTC <- retDbm$varComp$varComp[4];varYEps <- retDbm$varComp$varComp[6]
effectSize <- retDbm$ciDiffTrtRRRC$Estimate
````
The observed effect size is `effectSize` = `R effectSize`

### Random reader random case (RRRC)
This illustrates random reader random case sample size estimation. Assumed are 10 readers and 163 cases: `J <- 10; K <- 163` in the pivotal study. The non-centrality parameter is defined by:

\[\Delta =\frac{JK\sigma _{Y;\tau }^{2}}{\left( \sigma _{Y;\varepsilon }^{2}+\sigma _{Y;\tau RC}^{2} \right)+K\sigma _{Y;\tau R}^{2}+J\max \left( \sigma _{Y;\tau C}^{2},0 \right)}\]

Also, 

\[\sigma _{Y;\tau }^{2}={{d}^{2}}/2\]

where `d` is the observed effect size, `effectSize`. The formulae for calculating the mean-squares are in [@RN1476], implemented in `UtilMeanSquares()`.

```{r}
#RRRC
J <- 10; K <- 163 # in the pivotal study
ncp <- (0.5*J*K*(effectSize)^2)/(K*varYTR+max(J*varYTC,0)+varYEps)
MS <- UtilMeanSquares(rocData, FOM = "Wilcoxon", method = "DBMH")
ddf <- (MS$msTR+max(MS$msTC-MS$msTRC,0))^2/(MS$msTR^2)*(J-1)
FCrit <- qf(1 - alpha, 1, ddf)
Power <- 1-pf(FCrit, 1, ddf, ncp = ncp)
````

The next line calculates the non centrality parameter, `ncp` = `r ncp`. Note that `effectSize` enters as the **square**. Using the `UtilMeanSquares()` function returns the mean-squares as a `list`. The next line calculates `ddf` = `r ddf`. The remaining lines calculate the critical value of the F-distribution, `FCrit` = `r qf(1 - alpha, 1, ddf)` and the statistical power = `r Power`.

### Fixed reader random case (FRRC)
This code illustrates fixed reader random case sample size estimation. Assumed are 10 readers and 133 cases: `J <- 10; K <- 133` in the pivotal study.  

```{r}
#FRRC
J <- 10; K <- 133 # in the pivotal study
ncp <- (0.5*J*K*(effectSize)^2)/(max(J*varYTC,0)+varYEps)
ddf <- (K-1)
FCrit <- qf(1 - alpha, 1, ddf)
Power <- 1-pf(FCrit, 1, ddf, ncp = ncp)
````
This time non centrality parameter, `ncp` = `r ncp`, `ddf` = `r ddf`, `FCrit` = `r qf(1 - alpha, 1, ddf)` and statistical power = `r Power`.

### Random reader fixed case (RRFC)
This code illustrates random reader random case sample size estimation. Assumed are 10 readers and 53 cases: `J <- 10; K <- 5` in the pivotal study.
```{r}
#RRFC
J <- 10; K <- 53 # in the pivotal study
ncp <- (0.5*J*K*(effectSize)^2)/(K*varYTR+varYEps)
ddf <- (J-1)
FCrit <- qf(1 - alpha, 1, ddf)
Power <- 1-pf(FCrit, 1, ddf, ncp = ncp)
````

This time non centrality parameter, `ncp` = `r ncp`, `ddf` = `r ddf`, `FCrit` = `r qf(1 - alpha, 1, ddf)` and statistical power = `r Power`.

## Summary
For 10 readers, the numbers of cases needed for 80% power is largest (163) for RRRC and least for RRFC (53). For all three analyses, the expectation of 80% power is met. 

# References


